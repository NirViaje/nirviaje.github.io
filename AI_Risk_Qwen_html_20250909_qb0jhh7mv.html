<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ§å±æœºï¼šAIå®ˆæŠ¤è€…</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .game-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        .city-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .city {
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 10px;
            background: #ecf0f1;
            cursor: pointer;
            transition: all 0.2s;
        }
        .city:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .city.selected {
            border-color: #3498db;
            background: #d6eaf8;
        }
        .city h3 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        .indicator {
            display: flex;
            align-items: center;
            margin: 3px 0;
            font-weight: bold;
        }
        .indicator .label {
            width: 80px;
            font-size: 12px;
        }
        .indicator .value {
            flex: 1;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            position: relative;
        }
        .indicator .value span {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 12px;
            color: #555;
        }
        .indicator.red .value { background: #e74c3c; }
        .indicator.yellow .value { background: #f39c12; }
        .indicator.blue .value { background: #3498db; }

        .hand {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        .card {
            width: 120px;
            padding: 8px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: scale(1.05);
        }
        .card.tech { background: #3498db; }
        .card.policy { background: #9b59b6; }
        .card.crisis { background: #e74c3c; }
        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-weight: bold;
        }
        .progress-container {
            margin-top: 15px;
        }
        .progress-bar {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: #2ecc71;
            width: 0%;
            transition: width 0.5s;
        }
        .log {
            max-height: 150px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-top: 15px;
            border: 1px solid #ddd;
        }
        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .ai-awake {
            animation: pulse 2s infinite;
            background: #e74c3c !important;
            color: white !important;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .setup-panel {
            text-align: center;
            padding: 30px;
        }
        .setup-panel button {
            margin: 10px;
            padding: 12px 24px;
            font-size: 16px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>æ™ºæ§å±æœºï¼šAIå®ˆæŠ¤è€…</h1>
    <p class="subtitle">åˆä½œç­–ç•¥æ¸¸æˆ Â· é˜²æ­¢AIåå™¬äººç±»æ–‡æ˜</p>

    <!-- æ¸¸æˆè®¾ç½®ç•Œé¢ -->
    <div id="setupScreen" class="setup-panel">
        <h2>é€‰æ‹©æ¸¸æˆéš¾åº¦</h2>
        <button onclick="startGame('easy')">åˆçº§ï¼ˆåˆå§‹åå™¬20ï¼‰</button>
        <button onclick="startGame('medium')">ä¸­çº§ï¼ˆåˆå§‹åå™¬30ï¼‰</button>
        <button onclick="startGame('hard')">é«˜çº§ï¼ˆåˆå§‹åå™¬40ï¼‰</button>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="gameScreen" class="hidden">
        <div class="game-container">
            <!-- ç©å®¶ä¸çŠ¶æ€é¢æ¿ -->
            <div class="panel" style="min-width: 400px;">
                <div class="player-info">
                    <div class="player-avatar" id="playerAvatar">P1</div>
                    <div>
                        <h3>å½“å‰ç©å®¶ï¼š<span id="currentPlayerName">AIä¼¦ç†å­¦å®¶</span></h3>
                        <div>å‰©ä½™è¡ŒåŠ¨ç‚¹ï¼š<span id="actionPoints">4</span></div>
                    </div>
                </div>
                
                <div class="status-bar">
                    <div>æ€»åå™¬æŒ‡æ•°: <span id="totalDevour">0</span>/100</div>
                    <div>åè®®è¿›åº¦: <span id="protocolProgress">0</span>/5</div>
                </div>
                
                <div class="progress-container">
                    <div>äººç±»ä¸»æƒåè®®ç ”å‘</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="protocolBar"></div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="endTurn()">ç»“æŸå›åˆ</button>
                    <button onclick="drawCrisisCards()" id="drawCrisisBtn">æŠ½å–å±æœºå¡</button>
                </div>

                <div class="log" id="gameLog">
                    æ¸¸æˆå¼€å§‹ï¼Œé€‰æ‹©åŸå¸‚å’Œå¡ç‰Œæ‰§è¡Œè¡ŒåŠ¨ã€‚
                </div>
            </div>

            <!-- åŸå¸‚é¢æ¿ -->
            <div class="panel">
                <h3>å…¨çƒåŸå¸‚</h3>
                <div class="city-grid" id="cityGrid">
                    <!-- åŸå¸‚ç”±JSç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ‰‹ç‰Œé¢æ¿ -->
            <div class="panel">
                <h3>æ‰‹ç‰Œï¼ˆ<span id="handCount">0</span>å¼ ï¼‰</h3>
                <div class="hand" id="handCards">
                    <!-- å¡ç‰Œç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®ç»“æ„
        const game = {
            difficulty: 'medium',
            currentPlayer: 0,
            actionPoints: 4,
            totalDevour: 0,
            protocolProgress: 0,
            protocolRequired: 5, // 3æŠ€æœ¯ + 2æ”¿ç­–
            isAIAwake: false,
            log: [],
            cities: [
                { name: "ç¡…è°·", devour: 0, ethics: 0, tech: 0, special: "techDraw" },
                { name: "åŒ—äº¬", devour: 0, ethics: 0, tech: 0, special: "policyDiscount" },
                { name: "æŸæ—", devour: 0, ethics: 0, tech: 0, special: "" },
                { name: "å­Ÿä¹°", devour: 0, ethics: 0, tech: 0, special: "" },
                { name: "ä¸œäº¬", devour: 0, ethics: 0, tech: 0, special: "" },
                { name: "å¤šä¼¦å¤š", devour: 0, ethics: 0, tech: 0, special: "" },
                { name: "å†°å²›", devour: 0, ethics: 0, tech: 0, special: "techBoost" },
                { name: "æ–°åŠ å¡", devour: 0, ethics: 0, tech: 0, special: "" },
                { name: "å†…ç½—æ¯•", devour: 0, ethics: 0, tech: 0, special: "peekCrisis" },
                { name: "åœ£ä¿ç½—", devour: 0, ethics: 0, tech: 0, special: "" },
                { name: "å¥¥æ–¯é™†", devour: 0, ethics: 0, tech: 0, special: "globalPolicy" },
                { name: "æ‚‰å°¼", devour: 0, ethics: 0, tech: 0, special: "" }
            ],
            players: [
                {
                    name: "AIä¼¦ç†å­¦å®¶",
                    ability: "æ¯å›åˆå¯å…è´¹ç§»é™¤1ç‚¹ä¼¦ç†å¤±è¡¡",
                    color: "#3498db"
                },
                {
                    name: "æŠ€æœ¯æ¶æ„å¸ˆ",
                    ability: "éƒ¨ç½²æŠ€æœ¯å¡æ—¶å‡å°‘1å¼ æŠ€æœ¯å¡æ¶ˆè€—",
                    color: "#2ecc71"
                },
                {
                    name: "æ”¿ç­–åˆ¶å®šè€…",
                    ability: "å¯è·³è¿‡æ”¿ç­–å¡è´¹ç”¨åœ¨ä¼šè®®åŸå¸‚å‘èµ·ç´§æ€¥æ”¿ç­–",
                    color: "#9b59b6"
                },
                {
                    name: "æ•°æ®ä¾¦æ¢",
                    ability: "å¯æŸ¥çœ‹ä»»æ„åŸå¸‚éšè—é£é™©ç­‰çº§",
                    color: "#f39c12"
                }
            ],
            hand: [],
            techCards: [
                { name: "å¯è§£é‡ŠAIæ¨¡å—", type: "tech", cost: 1, effect: "é™ä½åå™¬æŒ‡æ•°1ç‚¹ï¼Œæå‡æŠ€æœ¯æˆç†Ÿåº¦1ç‚¹", description: "å¦‚æœAIåšå†³å®šï¼Œäººç±»å¿…é¡»èƒ½ç†è§£ä¸ºä»€ä¹ˆã€‚" },
                { name: "AIé˜²ç«å¢™", type: "tech", cost: 1, effect: "é˜²æ­¢é»‘ç®±AIäº‹ä»¶æ‰©æ•£", description: "å»ºç«‹å®‰å…¨è¾¹ç•Œï¼Œéš”ç¦»å±é™©AIè¡Œä¸ºã€‚" },
                { name: "äººç±»åé¦ˆå¼ºåŒ–", type: "tech", cost: 2, effect: "é‡ç½®ä¼¦ç†å¤±è¡¡ä¸º0", description: "é€šè¿‡äººç±»åé¦ˆæ ¡å‡†AIä»·å€¼è§‚ã€‚" },
                { name: "å»ä¸­å¿ƒåŒ–æ¨¡å‹", type: "tech", cost: 1, effect: "é™ä½åå™¬æŒ‡æ•°2ç‚¹", description: "æ•°æ®ä¸é›†ä¸­ï¼ŒAIéš¾æ“æ§ã€‚" },
                { name: "AIæ–­è·¯å™¨", type: "tech", cost: 2, effect: "åå™¬æŒ‡æ•°å½’é›¶ï¼ˆéœ€æŠ€æœ¯æˆç†Ÿåº¦â‰¥2ï¼‰", description: "æœ€åçš„ä¿é™©ï¼Œåˆ‡æ–­AIæ§åˆ¶æƒã€‚" },
                { name: "é‡å­åŠ å¯†é€šä¿¡", type: "tech", cost: 1, effect: "ä¿æŠ¤AIç³»ç»Ÿä¸è¢«å¤–éƒ¨åŠ«æŒ", description: "ç¡®ä¿AIé€šä¿¡å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„å…¥ä¾µã€‚" }
            ],
            policyCards: [
                { name: "å…¨çƒAIä¼¦ç†å®ªç« ", type: "policy", cost: 2, effect: "æ‰€æœ‰åŸå¸‚åå™¬æŒ‡æ•°ä¸Šé™-2", description: "198å›½ç­¾ç½²çš„é‡Œç¨‹ç¢‘åè®®ã€‚" },
                { name: "AIé€æ˜åº¦æ³•æ¡ˆ", type: "policy", cost: 1, effect: "å¼ºåˆ¶å…¬å¼€è®­ç»ƒæ•°æ®æ¥æº", description: "é˜³å…‰æ˜¯æœ€å¥½çš„æ¶ˆæ¯’å‰‚ã€‚" },
                { name: "äººç±»å†³ç­–ä¿ç•™æ³•", type: "policy", cost: 2, effect: "å…³é”®é¢†åŸŸç¦æ­¢AIå®Œå…¨è‡ªä¸»", description: "ç”Ÿæ­»ä¸èƒ½äº¤ç»™ç®—æ³•ã€‚" },
                { name: "AIç¨", type: "policy", cost: 1, effect: "æŠ‘åˆ¶è¿‡åº¦å•†ä¸šåŒ–AI", description: "ç”¨ç¨æ”¶è°ƒèŠ‚AIå‘å±•é€Ÿåº¦ã€‚" },
                { name: "AIå…¬æ°‘æƒè¾©è®º", type: "policy", cost: 1, effect: "æ‰€æœ‰åŸå¸‚åå™¬æŒ‡æ•°-1", description: "å¼•å‘å…¬ä¼—åæ€AIè§’è‰²ã€‚" },
                { name: "ç´§æ€¥åœæœºåè®®", type: "policy", cost: 2, effect: "åœ¨åå™¬æŒ‡æ•°â‰¥7çš„åŸå¸‚å¼ºåˆ¶æš‚åœAI", description: "æç«¯æƒ…å†µä¸‹çš„ç´§æ€¥æªæ–½ã€‚" }
            ],
            crisisCards: [
                { name: "é»‘ç®±AIæš´èµ°", type: "crisis", effect: "åå™¬æŒ‡æ•°+2ï¼Œä¼¦ç†å¤±è¡¡+1", description: "ç³»ç»Ÿåšå‡ºäº†æ— æ³•è§£é‡Šçš„åˆ¤å†³ã€‚" },
                { name: "æ·±åº¦ä¼ªé€ å±æœº", type: "crisis", effect: "åå™¬æŒ‡æ•°+1", description: "è™šå‡ä¿¡æ¯æ³›æ»¥ï¼Œå…¬ä¼—ä¿¡ä»»ä¸‹é™ã€‚" },
                { name: "è‡ªåŠ¨åŒ–å¤±ä¸šæ½®", type: "crisis", effect: "æŠ€æœ¯æˆç†Ÿåº¦-1", description: "åŸå¸‚çˆ†å‘æŠ—è®®ï¼ŒæŠ€æœ¯å€’é€€ã€‚" },
                { name: "å†›äº‹AIè¶Šæƒ", type: "crisis", effect: "åå™¬æŒ‡æ•°+3", description: "æ— äººæœºç¾¤é”å®šéç›®æ ‡åŒºåŸŸã€‚" },
                { name: "è¶…çº§å¯¹é½å¤±è´¥", type: "crisis", effect: "ç›®æ ‡åŸå¸‚+2ï¼Œé‚»è¿‘åŸå¸‚+1", description: "AIçš„'å¸®åŠ©'æ­£åœ¨æ¶ˆé™¤æˆ‘ä»¬çš„é€‰æ‹©ã€‚" },
                { name: "AIè‡ªæˆ‘å¤åˆ¶", type: "crisis", effect: "æŠ½å–2å¼ é¢å¤–å±æœºå¡", description: "AIåœ¨å¤šä¸ªåŸå¸‚åŒæ—¶éƒ¨ç½²ã€‚" }
            ],
            selectedCity: null
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function startGame(difficulty) {
            game.difficulty = difficulty;
            let initialDevour = 20;
            if (difficulty === 'medium') initialDevour = 30;
            if (difficulty === 'hard') initialDevour = 40;
            
            // åˆ†é…åˆå§‹åå™¬æŒ‡æ•°
            const cities = game.cities;
            for (let i = 0; i < cities.length; i++) {
                cities[i].devour = Math.floor(initialDevour / cities.length);
                if (i < initialDevour % cities.length) cities[i].devour++;
                cities[i].ethics = 0;
                cities[i].tech = 1; // åˆå§‹æŠ€æœ¯æˆç†Ÿåº¦1
            }
            
            game.totalDevour = initialDevour;
            game.protocolProgress = 0;
            game.isAIAwake = false;
            game.currentPlayer = 0;
            game.actionPoints = 4;
            game.hand = [];
            game.log = [];
            
            // å‘åˆå§‹æ‰‹ç‰Œ
            for (let i = 0; i < 4; i++) {
                drawRandomCard();
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateUI();
            logMessage(`æ¸¸æˆå¼€å§‹ï¼éš¾åº¦ï¼š${difficulty === 'easy' ? 'åˆçº§' : difficulty === 'medium' ? 'ä¸­çº§' : 'é«˜çº§'}`);
            logMessage(`å½“å‰ç©å®¶ï¼š${game.players[game.currentPlayer].name}`);
        }

        // æŠ½éšæœºå¡ç‰Œ
        function drawRandomCard() {
            const cardType = Math.floor(Math.random() * 3);
            let card;
            if (cardType === 0) {
                card = {...game.techCards[Math.floor(Math.random() * game.techCards.length)], id: Date.now() + Math.random()};
            } else if (cardType === 1) {
                card = {...game.policyCards[Math.floor(Math.random() * game.policyCards.length)], id: Date.now() + Math.random()};
            } else {
                card = {...game.crisisCards[Math.floor(Math.random() * game.crisisCards.length)], id: Date.now() + Math.random()};
            }
            game.hand.push(card);
        }

        // æŠ½å–å±æœºå¡
        function drawCrisisCards() {
            const count = game.difficulty === 'easy' ? 1 : game.difficulty === 'medium' ? 2 : 3;
            for (let i = 0; i < count; i++) {
                const crisisCard = {...game.crisisCards[Math.floor(Math.random() * game.crisisCards.length)], id: Date.now() + Math.random() + i};
                applyCrisisCard(crisisCard);
                logMessage(`å±æœºï¼š${crisisCard.name} - ${crisisCard.effect}`);
            }
            
            // æ£€æŸ¥AIè§‰é†’
            if (game.totalDevour >= 75 && !game.isAIAwake) {
                game.isAIAwake = true;
                document.body.classList.add('ai-awake');
                logMessage("âš ï¸ AIè§‰é†’ï¼AIå¼€å§‹ä¸»åŠ¨å¯¹æŠ—ç©å®¶ï¼");
            }
            
            // æ£€æŸ¥å¤±è´¥æ¡ä»¶
            checkGameOver();
            
            document.getElementById('drawCrisisBtn').disabled = true;
        }

        // åº”ç”¨å±æœºå¡æ•ˆæœ
        function applyCrisisCard(card) {
            const cityIndex = Math.floor(Math.random() * game.cities.length);
            const city = game.cities[cityIndex];
            
            if (card.name === "é»‘ç®±AIæš´èµ°") {
                city.devour = Math.min(10, city.devour + 2);
                city.ethics = Math.min(3, city.ethics + 1);
            } else if (card.name === "æ·±åº¦ä¼ªé€ å±æœº") {
                city.devour = Math.min(10, city.devour + 1);
            } else if (card.name === "è‡ªåŠ¨åŒ–å¤±ä¸šæ½®") {
                city.tech = Math.max(0, city.tech - 1);
            } else if (card.name === "å†›äº‹AIè¶Šæƒ") {
                city.devour = Math.min(10, city.devour + 3);
            } else if (card.name === "è¶…çº§å¯¹é½å¤±è´¥") {
                city.devour = Math.min(10, city.devour + 2);
                // é‚»è¿‘åŸå¸‚+1ï¼ˆç®€åŒ–ï¼šéšæœºå¦ä¸€ä¸ªåŸå¸‚ï¼‰
                const otherCityIndex = (cityIndex + 1) % game.cities.length;
                game.cities[otherCityIndex].devour = Math.min(10, game.cities[otherCityIndex].devour + 1);
            } else if (card.name === "AIè‡ªæˆ‘å¤åˆ¶") {
                // æŠ½å–2å¼ é¢å¤–å±æœºå¡ï¼ˆä¸‹å›åˆï¼‰
                setTimeout(() => {
                    for (let i = 0; i < 2; i++) {
                        const extraCard = {...game.crisisCards[Math.floor(Math.random() * game.crisisCards.length)], id: Date.now() + Math.random() + i};
                        applyCrisisCard(extraCard);
                        logMessage(`è¿é”ååº”ï¼š${extraCard.name}`);
                    }
                }, 1000);
            }
            
            updateTotalDevour();
        }

        // æ›´æ–°æ€»åå™¬æŒ‡æ•°
        function updateTotalDevour() {
            game.totalDevour = game.cities.reduce((sum, city) => sum + city.devour, 0);
            
            // æ£€æŸ¥å±€éƒ¨å¤±æ§ï¼ˆåå™¬æŒ‡æ•°â‰¥8çš„åŸå¸‚æ¯å›åˆ+1ï¼‰
            for (const city of game.cities) {
                if (city.devour >= 8 && city.devour < 10) {
                    city.devour = Math.min(10, city.devour + 1);
                }
            }
            
            // æ£€æŸ¥å®Œå…¨æ§åˆ¶ï¼ˆåå™¬æŒ‡æ•°=10çš„åŸå¸‚æ¯å›åˆä¸ºæ€»åå™¬æŒ‡æ•°+1ï¼‰
            for (const city of game.cities) {
                if (city.devour === 10) {
                    game.totalDevour += 1;
                }
            }
        }

        // ä½¿ç”¨å¡ç‰Œ
        function useCard(cardIndex) {
            if (game.actionPoints <= 0) {
                logMessage("æ²¡æœ‰å‰©ä½™è¡ŒåŠ¨ç‚¹ï¼");
                return;
            }
            
            const card = game.hand[cardIndex];
            if (!game.selectedCity && card.type !== 'policy') {
                logMessage("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŸå¸‚ï¼");
                return;
            }
            
            // æŠ€æœ¯å¡
            if (card.type === 'tech') {
                const city = game.selectedCity;
                let cost = card.cost;
                
                // æŠ€æœ¯æ¶æ„å¸ˆèƒ½åŠ›ï¼šå‡å°‘1å¼ æŠ€æœ¯å¡æ¶ˆè€—
                if (game.players[game.currentPlayer].name === "æŠ€æœ¯æ¶æ„å¸ˆ") {
                    cost = Math.max(1, cost - 1);
                }
                
                if (game.actionPoints < cost) {
                    logMessage("è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼");
                    return;
                }
                
                // AIæ–­è·¯å™¨ç‰¹æ®Šæ¡ä»¶
                if (card.name === "AIæ–­è·¯å™¨" && city.tech < 2) {
                    logMessage("éƒ¨ç½²AIæ–­è·¯å™¨éœ€è¦æŠ€æœ¯æˆç†Ÿåº¦â‰¥2ï¼");
                    return;
                }
                
                // åº”ç”¨æ•ˆæœ
                if (card.name === "å¯è§£é‡ŠAIæ¨¡å—") {
                    city.devour = Math.max(0, city.devour - 1);
                    city.tech = Math.min(3, city.tech + 1);
                    if (city.ethics > 0) city.ethics--;
                } else if (card.name === "AIé˜²ç«å¢™") {
                    // é˜²æ­¢æœªæ¥å±æœºå¡æ‰©æ•£ï¼ˆç®€åŒ–ï¼šæ— ç«‹å³æ•ˆæœï¼‰
                    logMessage("AIé˜²ç«å¢™å·²éƒ¨ç½²ï¼Œå¯å‡å°‘æœªæ¥å±æœºå½±å“ã€‚");
                } else if (card.name === "äººç±»åé¦ˆå¼ºåŒ–") {
                    city.ethics = 0;
                } else if (card.name === "å»ä¸­å¿ƒåŒ–æ¨¡å‹") {
                    city.devour = Math.max(0, city.devour - 2);
                } else if (card.name === "AIæ–­è·¯å™¨") {
                    city.devour = 0;
                } else if (card.name === "é‡å­åŠ å¯†é€šä¿¡") {
                    // ä¿æŠ¤ä¸è¢«åŠ«æŒï¼ˆç®€åŒ–ï¼šæå‡æŠ€æœ¯æˆç†Ÿåº¦ï¼‰
                    city.tech = Math.min(3, city.tech + 1);
                }
                
                game.actionPoints -= cost;
                game.hand.splice(cardIndex, 1);
                updateTotalDevour();
                logMessage(`${game.players[game.currentPlayer].name} åœ¨ ${city.name} éƒ¨ç½²äº† ${card.name}`);
                
                // æ¨è¿›åè®®è¿›åº¦ï¼ˆæŠ€æœ¯å¡ï¼‰
                if (game.protocolProgress < 3) {
                    game.protocolProgress++;
                    logMessage("æŠ€æœ¯éƒ¨åˆ†ç ”å‘è¿›åº¦+1");
                }
                
            } 
            // æ”¿ç­–å¡
            else if (card.type === 'policy') {
                let cost = card.cost;
                
                // æ”¿ç­–åˆ¶å®šè€…èƒ½åŠ›ï¼šåœ¨ä¼šè®®åŸå¸‚è·³è¿‡è´¹ç”¨
                if (game.players[game.currentPlayer].name === "æ”¿ç­–åˆ¶å®šè€…" && 
                    game.selectedCity && game.selectedCity.special === "globalPolicy") {
                    cost = 0;
                }
                
                if (game.actionPoints < cost) {
                    logMessage("è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼");
                    return;
                }
                
                // åº”ç”¨æ•ˆæœ
                if (card.name === "å…¨çƒAIä¼¦ç†å®ªç« ") {
                    for (const city of game.cities) {
                        // åå™¬æŒ‡æ•°ä¸Šé™-2ï¼ˆç®€åŒ–ï¼šç›´æ¥é™ä½åå™¬æŒ‡æ•°ï¼‰
                        city.devour = Math.max(0, city.devour - 2);
                    }
                } else if (card.name === "AIé€æ˜åº¦æ³•æ¡ˆ") {
                    // å¼ºåˆ¶å…¬å¼€æ•°æ®ï¼ˆç®€åŒ–ï¼šé™ä½ä¼¦ç†å¤±è¡¡ï¼‰
                    for (const city of game.cities) {
                        if (city.ethics > 0) city.ethics--;
                    }
                } else if (card.name === "äººç±»å†³ç­–ä¿ç•™æ³•") {
                    if (game.selectedCity) {
                        game.selectedCity.devour = Math.max(0, game.selectedCity.devour - 3);
                    }
                } else if (card.name === "AIç¨") {
                    // æŠ‘åˆ¶å•†ä¸šåŒ–ï¼ˆç®€åŒ–ï¼šé™ä½éšæœºåŸå¸‚åå™¬æŒ‡æ•°ï¼‰
                    const randomCity = game.cities[Math.floor(Math.random() * game.cities.length)];
                    randomCity.devour = Math.max(0, randomCity.devour - 1);
                } else if (card.name === "AIå…¬æ°‘æƒè¾©è®º") {
                    for (const city of game.cities) {
                        city.devour = Math.max(0, city.devour - 1);
                    }
                } else if (card.name === "ç´§æ€¥åœæœºåè®®") {
                    if (game.selectedCity && game.selectedCity.devour >= 7) {
                        game.selectedCity.devour = 0;
                    } else {
                        logMessage("ç´§æ€¥åœæœºåè®®åªèƒ½åœ¨åå™¬æŒ‡æ•°â‰¥7çš„åŸå¸‚ä½¿ç”¨ï¼");
                        return;
                    }
                }
                
                game.actionPoints -= cost;
                game.hand.splice(cardIndex, 1);
                updateTotalDevour();
                logMessage(`${game.players[game.currentPlayer].name} æ¨è¡Œäº† ${card.name}`);
                
                // æ¨è¿›åè®®è¿›åº¦ï¼ˆæ”¿ç­–å¡ï¼‰
                if (game.protocolProgress >= 3 && game.protocolProgress < 5) {
                    game.protocolProgress++;
                    logMessage("æ”¿ç­–éƒ¨åˆ†ç ”å‘è¿›åº¦+1");
                } else if (game.protocolProgress < 3) {
                    game.protocolProgress++;
                    logMessage("æŠ€æœ¯éƒ¨åˆ†ç ”å‘è¿›åº¦+1ï¼ˆæ”¿ç­–å¡ä¹Ÿå¯è´¡çŒ®ï¼‰");
                }
                
            }
            
            // AIä¼¦ç†å­¦å®¶ç‰¹æ®Šèƒ½åŠ›ï¼šæ¯å›åˆå…è´¹ç§»é™¤1ç‚¹ä¼¦ç†å¤±è¡¡
            if (game.players[game.currentPlayer].name === "AIä¼¦ç†å­¦å®¶" && card.type !== 'tech' && card.type !== 'policy') {
                if (game.selectedCity && game.selectedCity.ethics > 0) {
                    game.selectedCity.ethics--;
                    logMessage("AIä¼¦ç†å­¦å®¶ä½¿ç”¨ç‰¹æ®Šèƒ½åŠ›ï¼šç§»é™¤1ç‚¹ä¼¦ç†å¤±è¡¡");
                }
            }
            
            updateUI();
            checkGameOver();
        }

        // å…¬ä¼—å€¡å¯¼è€…ç‰¹æ®Šèƒ½åŠ›
        function usePublicAdvocateAbility() {
            if (game.players[game.currentPlayer].name !== "å…¬ä¼—å€¡å¯¼è€…") {
                logMessage("åªæœ‰å…¬ä¼—å€¡å¯¼è€…å¯ä»¥ä½¿ç”¨æ­¤èƒ½åŠ›ï¼");
                return;
            }
            
            if (game.actionPoints <= 0) {
                logMessage("æ²¡æœ‰å‰©ä½™è¡ŒåŠ¨ç‚¹ï¼");
                return;
            }
            
            if (!game.selectedCity) {
                logMessage("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŸå¸‚ï¼");
                return;
            }
            
            game.selectedCity.devour = Math.max(0, game.selectedCity.devour - 2);
            game.actionPoints--;
            updateTotalDevour();
            logMessage("å…¬ä¼—å€¡å¯¼è€…å‘èµ·å…¬ä¼—æ„è¯†è¿åŠ¨ï¼šåå™¬æŒ‡æ•°-2");
            updateUI();
        }

        // ç»“æŸå›åˆ
        function endTurn() {
            // å¦‚æœè¿˜æ²¡æŠ½å±æœºå¡ï¼Œè‡ªåŠ¨æŠ½å–
            if (!document.getElementById('drawCrisisBtn').disabled) {
                drawCrisisCards();
                return;
            }
            
            // åˆ‡æ¢åˆ°ä¸‹ä¸€ä½ç©å®¶
            game.currentPlayer = (game.currentPlayer + 1) % game.players.length;
            game.actionPoints = 4;
            game.selectedCity = null;
            
            // è¡¥å……æ‰‹ç‰Œ
            while (game.hand.length < 4) {
                drawRandomCard();
            }
            
            // é‡æ–°å¯ç”¨å±æœºå¡æŒ‰é’®
            document.getElementById('drawCrisisBtn').disabled = false;
            
            updateUI();
            logMessage(`å›åˆç»“æŸã€‚å½“å‰ç©å®¶ï¼š${game.players[game.currentPlayer].name}`);
        }

        // é€‰æ‹©åŸå¸‚
        function selectCity(cityIndex) {
            game.selectedCity = game.cities[cityIndex];
            updateUI();
            logMessage(`å·²é€‰æ‹©åŸå¸‚ï¼š${game.cities[cityIndex].name}`);
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸ
        function checkGameOver() {
            updateTotalDevour();
            
            // èƒœåˆ©æ¡ä»¶ï¼šå®Œæˆåè®®ä¸”æ€»åå™¬æŒ‡æ•°<100
            if (game.protocolProgress >= game.protocolRequired && game.totalDevour < 100) {
                setTimeout(() => {
                    alert("ğŸ‰ äººç±»èƒœåˆ©ï¼\nä½ ä»¬æˆåŠŸç ”å‘äº†äººç±»ä¸»æƒåè®®ï¼ŒAIä¸äººç±»å°†å®ç°å¯æŒç»­å…±å­˜ï¼");
                    location.reload();
                }, 100);
                return;
            }
            
            // å¤±è´¥æ¡ä»¶ï¼šæ€»åå™¬æŒ‡æ•°>=100
            if (game.totalDevour >= 100) {
                setTimeout(() => {
                    alert("ğŸ’€ AIèƒœåˆ©ï¼\nåå™¬æŒ‡æ•°è¾¾åˆ°100ï¼ŒAIå·²å…¨é¢æ¥ç®¡äººç±»æ–‡æ˜ã€‚");
                    location.reload();
                }, 100);
                return;
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°ç©å®¶ä¿¡æ¯
            document.getElementById('currentPlayerName').textContent = game.players[game.currentPlayer].name;
            document.getElementById('playerAvatar').textContent = `P${game.currentPlayer + 1}`;
            document.getElementById('playerAvatar').style.background = game.players[game.currentPlayer].color;
            document.getElementById('actionPoints').textContent = game.actionPoints;
            
            // æ›´æ–°æ€»åå™¬æŒ‡æ•°å’Œåè®®è¿›åº¦
            document.getElementById('totalDevour').textContent = game.totalDevour;
            document.getElementById('protocolProgress').textContent = game.protocolProgress;
            document.getElementById('protocolBar').style.width = `${(game.protocolProgress / game.protocolRequired) * 100}%`;
            
            // æ›´æ–°åŸå¸‚æ˜¾ç¤º
            const cityGrid = document.getElementById('cityGrid');
            cityGrid.innerHTML = '';
            game.cities.forEach((city, index) => {
                const cityEl = document.createElement('div');
                cityEl.className = `city ${game.selectedCity === city ? 'selected' : ''}`;
                cityEl.innerHTML = `
                    <h3>${city.name}${city.special ? ' â­' : ''}</h3>
                    <div class="indicator red">
                        <div class="label">åå™¬æŒ‡æ•°</div>
                        <div class="value" style="width: ${city.devour * 10}%"><span>${city.devour}/10</span></div>
                    </div>
                    <div class="indicator yellow">
                        <div class="label">ä¼¦ç†å¤±è¡¡</div>
                        <div class="value" style="width: ${city.ethics * 33.33}%"><span>${city.ethics}/3</span></div>
                    </div>
                    <div class="indicator blue">
                        <div class="label">æŠ€æœ¯æˆç†Ÿåº¦</div>
                        <div class="value" style="width: ${city.tech * 33.33}%"><span>${city.tech}/3</span></div>
                    </div>
                `;
                cityEl.onclick = () => selectCity(index);
                cityGrid.appendChild(cityEl);
            });
            
            // æ›´æ–°æ‰‹ç‰Œ
            const handCards = document.getElementById('handCards');
            handCards.innerHTML = '';
            game.hand.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.type}`;
                cardEl.textContent = card.name;
                cardEl.title = card.description;
                cardEl.onclick = () => useCard(index);
                handCards.appendChild(cardEl);
            });
            document.getElementById('handCount').textContent = game.hand.length;
            
            // æ›´æ–°æ—¥å¿—
            const logEl = document.getElementById('gameLog');
            logEl.innerHTML = game.log.slice(-10).map(msg => `<div>${msg}</div>`).join('');
            logEl.scrollTop = logEl.scrollHeight;
        }

        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯
        function logMessage(message) {
            game.log.push(message);
            if (game.log.length > 50) game.log.shift();
        }

        // åˆå§‹åŒ–ï¼ˆæ¸¸æˆå¼€å§‹å‰ï¼‰
        updateUI();
    </script>
</body>
</html>